(function(e){function n(){this._routes=null,this._routesByName=null}function r(e,t,n,i,s){e=e.toUpperCase();if(!r.HTTP_METHODS_REGEXP.test(e))throw'Invalid http method "'+e+'"';if(typeof t!="string")throw"Argument 2 (name) must be string";if(typeof n!="string")throw"Argument 3 (pattern) must be string";n+=r.GROUP_OPENED_CHAR+"?"+r.PARAM_OPENED_CHARS+"query_string"+r.PARAM_CLOSED_CHARS+r.GROUP_CLOSED_CHAR,i||(i={}),i.query_string=".*",this._method=e,this._name=t,this._pattern=n,this._conditions=i,this._defaults=s||null,this._data=null,this.parsePattern().buildParseRegExp().buildBuildFn()}var t=Object.prototype.hasOwnProperty;n.prototype.addRoute=function(e,t,n,i,s){var o;return o=new r(e,t,n,i,s),this._routes||(this._routes=[]),this._routes.push(o),this._routesByName||(this._routesByName={}),this._routesByName[t]=o,o},n.prototype.find=function(){var e=null,t,n,r,i=this._routes;if(i)for(n=0,r=i.length;n<r;++n){t=i[n].parse.apply(i[n],arguments);if(t!==null){e=[i[n],t];break}}return e},n.prototype.getRouteByName=function(e){return this._routesByName&&this._routesByName[e]||null},n.prototype.bundle=function(){return this._routes&&this._routes.map(function(e){return e.bundle()})},r.querystring=require("querystring"),r.escape=function(){var e=["/",".","*","+","?","|","(",")","[","]","{","}","\\"],t=new RegExp("(\\"+e.join("|\\")+")","g");return function(e){return e.replace(t,"\\$1")}}(),r.HTTP_METHODS=["GET","POST","DELETE","PUT"],r.HTTP_METHODS_REGEXP=new RegExp("^("+r.HTTP_METHODS.join("|")+")$"),r.PARAM_OPENED_CHARS="<",r.PARAM_CLOSED_CHARS=">",r.GROUP_OPENED_CHAR="(",r.GROUP_CLOSED_CHAR=")",r.PARAM_NAME_REGEXP_SOURCE="[a-zA-Z_][\\w\\-]*",r.PARAM_VALUE_REGEXP_SOURCE="[\\w\\-]+",r.PARSE_PARAMS_REGEXP=new RegExp("("+r.escape(r.PARAM_OPENED_CHARS)+r.PARAM_NAME_REGEXP_SOURCE+r.escape(r.PARAM_CLOSED_CHARS)+"|"+"[^"+r.escape(r.PARAM_OPENED_CHARS)+r.escape(r.PARAM_CLOSED_CHARS)+"]+"+"|"+r.escape(r.PARAM_OPENED_CHARS)+"|"+r.escape(r.PARAM_CLOSED_CHARS)+")","g"),r.prototype.parsePattern=function(){function e(n){var i=[],s="",o,u=0,a,f,l=0,c=!1,h=n.length;while(u<h){o=n.charAt(u++);if(o===r.GROUP_OPENED_CHAR)c?(++l,s+=o):(t(s,i),s="",l=0,c=!0);else if(o===r.GROUP_CLOSED_CHAR)if(c)if(l===0){s={what:"optional",dependOnParams:[],parts:e(s)},i.push(s);for(a=0,f=s.parts.length;a<f;++a)s.parts[a]&&s.parts[a].what==="param"&&s.dependOnParams.push(s.parts[a].name);s="",c=!1}else--l,s+=o;else s+=o;else s+=o}return t(s,i),i}function t(e,t){var n=e.match(r.PARSE_PARAMS_REGEXP);n&&n.forEach(function(e){e.indexOf(r.PARAM_OPENED_CHARS)===0&&e.lastIndexOf(r.PARAM_CLOSED_CHARS)===e.length-r.PARAM_CLOSED_CHARS.length?t.push({what:"param",name:e.substr(r.PARAM_OPENED_CHARS.length,e.length-r.PARAM_CLOSED_CHARS.length-1)}):t.push(e)})}return this._parts=e(this._pattern),this},r.prototype.buildParseRegExp=function(){function t(i){var s="";return i.forEach(function(i){typeof i=="string"?s+=r.escape(i):i&&i.what==="param"?(e._paramsMap.push(i.name),s+="("+n(i.name)+")"):i&&i.what==="optional"&&(s+="(?:"+t(i.parts)+")?")}),s}function n(t){var n="",i=e._conditions&&e._conditions[t];return i?Array.isArray(i)?n="(?:"+i.join("|")+")":n=i+"":n=r.PARAM_VALUE_REGEXP_SOURCE,n}var e=this;return this._paramsMap=[],this._parseRegExpSource="^"+t(this._parts)+"$",this._parseRegExp=new RegExp(this._parseRegExpSource),this},r.prototype.buildBuildFn=function(){function n(i){var s='""';return i.forEach(function(i){typeof i=="string"?s+='+"'+r.escape(i)+'"':i&&i.what==="param"?s+='+(h.call(p,"'+r.escape(i.name)+'")?'+'p["'+r.escape(i.name)+'"]:'+(e._defaults&&t.call(e._defaults,i.name)?'"'+r.escape(e._defaults[i.name])+'"':'""')+")":i&&i.what==="optional"&&(s+="+((false",i.dependOnParams.forEach(function(n){s+='||(h.call(p,"'+r.escape(n)+'")'+(e._defaults&&t.call(e._defaults,n)?'&&p["'+r.escape(n)+'"]!=="'+r.escape(e._defaults[n])+'"':"")+")"}),s+=")?("+n(i.parts)+'):"")')}),s}var e=this;return this._buildFnSource="var h=({}).hasOwnProperty;return "+n(this._parts)+";",this._buildFn=new Function("p",this._buildFnSource),this},r.prototype.parse=function(e,n){var i=null,s,o,u,a,f;n=n.toUpperCase();if(this._method===n){s=e.match(this._parseRegExp);if(s){i={};for(o=1,u=s.length;o<u;++o)typeof s[o]!="undefined"&&(i[this._paramsMap[o-1]]=s[o]);for(a in this._defaults)t.call(this._defaults,a)&&!t.call(i,a)&&(i[a]=this._defaults[a]);f=r.querystring.parse(i.query_string);for(a in f)t.call(f,a)&&!t.call(i,a)&&(i[a]=f[a]);delete i.query_string}}return i},r.prototype.build=function(e){var n={},i={},s,o;for(o in e)t.call(e,o)&&(this._paramsMap.indexOf(o)!==-1?n[o]=e[o]:i[o]=e[o]);return s=r.querystring.stringify(i),s&&(n.query_string=s),this._buildFn(n)},r.prototype.bind=function(e){return typeof e=="undefined"?this._data:(this._data=e,this)},r.prototype.bundle=function(){return[this._name,this._defaults,this._paramsMap,this._parseRegExpSource,this._buildFnSource,this._data&&this._data.controller]},e.Router=n})(this);