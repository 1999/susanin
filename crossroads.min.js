(function(e){function v(e){if(!e||typeof e!="object")throw new Error("You must specify options");if(typeof e.name!="string")throw new Error("You must specify name of route");this._name=e.name;if(typeof e.pattern!="string")throw new Error("You must specify pattern of route");this._pattern=e.pattern;if(typeof e.method=="string"){this._method=e.method.toUpperCase();if(!u.test(this._method))throw'Invalid http method "'+this._method+'"'}else this._method="GET";this._conditions=e.conditions&&typeof e.conditions=="object"?e.conditions:{},this._defaults=e.defaults&&typeof e.defaults=="object"?e.defaults:{},this._data=null,this._pattern+=l+"?"+a+"query_string"+f+c,this._conditions.query_string=".*",this.parsePattern().buildParseRegExp().buildBuildFn()}function m(){this._routes=[],this._routesByName={}}var t=Object.prototype.hasOwnProperty,n=Object.prototype.toString,r=function(e){return n.call(e)==="[object Array]"},i={parse:function(e,t,n){var r={},i,s,o,u,a,f;arguments.length||(e=location.search.substr(1));if(!e)return r;t||(t="&"),n||(n="="),i=e.split(t);for(a=0,f=i.length;a<f;++a)s=i[a].split(n),o=typeof s[1]!="undefined"?decodeURIComponent(s[1].replace(/\+/g,"%20")):"",u=decodeURIComponent(s[0]),r.hasOwnProperty(u)?Array.isArray(r[u])?r[u].push(o):r[u]=[r[u],o]:r[u]=o;return r},stringify:function(e,t,n){var r="",i,s,o,u,a,f;if(!e)return r;t||(t="&"),n||(n="=");for(f in e)if(e.hasOwnProperty(f)){o=[].concat(e[f]);for(u=0,a=o.length;u<a;++u)s=typeof o[u],s==="object"||s==="undefined"?i="":i=encodeURIComponent(o[u]),r+=t+encodeURIComponent(f)+n+i}return r.substr(t.length)}},s=function(){var e=["/",".","*","+","?","|","(",")","[","]","{","}","\\"],t=new RegExp("(\\"+e.join("|\\")+")","g");return function(e){return e.replace(t,"\\$1")}}(),o=["GET","POST","DELETE","PUT"],u=new RegExp("^("+o.join("|")+")$"),a="<",f=">",l="(",c=")",h="[a-zA-Z_][\\w\\-]*",p="[\\w\\-]+",d=new RegExp("("+s(a)+h+s(f)+"|"+"[^"+s(a)+s(f)+"]+"+"|"+s(a)+"|"+s(f)+")","g");v.prototype.parsePattern=function(){function e(n){var r=[],i="",s,o=0,u,a,f=0,h=!1,p=n.length;while(o<p){s=n.charAt(o++);if(s===l)h?(++f,i+=s):(t(i,r),i="",f=0,h=!0);else if(s===c)if(h)if(f===0){i={what:"optional",dependOnParams:[],parts:e(i)},r.push(i);for(u=0,a=i.parts.length;u<a;++u)i.parts[u]&&i.parts[u].what==="param"&&i.dependOnParams.push(i.parts[u].name);i="",h=!1}else--f,i+=s;else i+=s;else i+=s}return t(i,r),r}function t(e,t){var n=e.match(d),r,i,s;if(n)for(r=0,i=n.length;r<i;++r)s=n[r],s.charAt(0)===a&&s.charAt(s.length-1)===f?t.push({what:"param",name:s.substr(1,s.length-2)}):t.push(s)}return this._parts=e(this._pattern),this},v.prototype.buildParseRegExp=function(){function t(r){var i="",o,u,a;for(o=0,u=r.length;o<u;++o)a=r[o],typeof a=="string"?i+=s(a):a&&a.what==="param"?(e._paramsMap.push(a.name),i+="("+n(a.name)+")"):a&&a.what==="optional"&&(i+="(?:"+t(a.parts)+")?");return i}function n(t){var n="",i=e._conditions&&e._conditions[t];return i?r(i)?n="(?:"+i.join("|")+")":n=i+"":n=p,n}var e=this;return this._paramsMap=[],this._parseRegExpSource="^"+t(this._parts)+"$",this._parseRegExp=new RegExp(this._parseRegExpSource),this},v.prototype.buildBuildFn=function(){function n(r){var i='""',o,u,a,f,l,c;for(o=0,u=r.length;o<u;++o){l=r[o];if(typeof l=="string")i+='+"'+s(l)+'"';else if(l&&l.what==="param")i+='+(h.call(p,"'+s(l.name)+'")?'+'p["'+s(l.name)+'"]:'+(e._defaults&&t.call(e._defaults,l.name)?'"'+s(e._defaults[l.name])+'"':'""')+")";else if(l&&l.what==="optional"){i+="+((false";for(a=0,f=l.dependOnParams.length;a<f;++a)c=l.dependOnParams[a],i+='||(h.call(p,"'+s(c)+'")'+(e._defaults&&t.call(e._defaults,c)?'&&p["'+s(c)+'"]!=="'+s(e._defaults[c])+'"':"")+")";i+=")?("+n(l.parts)+'):"")'}}return i}var e=this;return this._buildFnSource="var h=({}).hasOwnProperty;return "+n(this._parts)+";",this._buildFn=new Function("p",this._buildFnSource),this},v.prototype.parse=function(e,n){var r=null,s,o,u,a,f;n=n.toUpperCase();if(this._method===n){s=e.match(this._parseRegExp);if(s){r={};for(o=1,u=s.length;o<u;++o)typeof s[o]!="undefined"&&(r[this._paramsMap[o-1]]=s[o]);for(a in this._defaults)t.call(this._defaults,a)&&!t.call(r,a)&&(r[a]=this._defaults[a]);f=i.parse(r.query_string);for(a in f)t.call(f,a)&&!t.call(r,a)&&(r[a]=f[a]);delete r.query_string}}return r},v.prototype.build=function(e){var n={},r={},s,o;for(o in e)t.call(e,o)&&(this._paramsMap.indexOf(o)!==-1?n[o]=e[o]:r[o]=e[o]);return s=i.stringify(r),s&&(n.query_string=s),this._buildFn(n)},v.prototype.bind=function(e){return typeof e=="undefined"?this._data:(this._data=e,this)},v.prototype.getName=function(){return this._name},v.prototype.bundle=function(){return[this._name,this._defaults,this._paramsMap,this._parseRegExpSource,this._buildFnSource,this._data&&this._data.controller]},m.prototype.addRoute=function(e){var t;return t=new v(e),this._routes.push(t),this._routesByName[t.getName()]=t,t},m.prototype.find=function(){var e,t,n,r=this._routes;for(t=0,n=r.length;t<n;++t){e=r[t].parse.apply(r[t],arguments);if(e!==null)return[r[t],e]}return null},m.prototype.getRouteByName=function(e){return this._routesByName[e]||null},m.prototype.bundle=function(){var e=null,t,n,r=this._routes;for(t=0,n=r.length;t<n;++t)e||(e=[]),e.push(r[t].bundle());return e},typeof module!="undefined"&&typeof module.exports=="object"?module.exports=m:e.Crossroads=m})(this);